<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Credential – Kool Ltd</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { margin:0; font-family: 'Georgia', serif; background:#f8e8ee; }
    #cert {
      position: relative;
      width: 900px; height: 600px;
      margin: 40px auto;
      background: url('https://raw.githubusercontent.com/francis-kool/ai-credentials-demo/main/images/ai-talk-credential-template.png') center/cover no-repeat;
      color: #333;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .overlay { position: absolute; text-align: center; width: 100%; }
    #logo img { width: 120px; position: relative; top: 60px; }
    #name     { top: 320px; font-size: 55px; font-weight: bold; color: #d48a4e; letter-spacing: 1px; }
    #talk     { top: 190px; font-size: 36px; color: #2c3e50; font-style: italic; }
    #date     { bottom: 60px; right: 250px; font-size: 22px; color: #444; }
    #issuer   { bottom: 80px; right: 120px; font-size: 20px; color: #444; text-align: right; }
    #timestamp{ bottom: 50px; right: 120px; font-size: 16px; color: #666; text-align: right; }
    #contract { bottom: 20px; left: 20px; font-size: 12px; color: #888; }
    #verified {
      position: absolute; top: 20px; right: 20px;
      background: #0f5132; color: white; padding: 10px 20px;
      border-radius: 30px; font-weight: bold; font-size: 14px;
    }
    #request {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      padding: 12px 30px; background: #c41e3a; color: white; border: none;
      font-size: 18px; border-radius: 8px; cursor: pointer;
    }
    #request:hover { background: #a0172e; }
  </style>
</head>
<body>

<div id="cert">
  <div class="overlay" id="logo"><img src="https://raw.githubusercontent.com/francis-kool/ai-credentials-demo/refs/heads/main/credential/logo.webp"></div>
  <div class="overlay" id="certificate">Certificate of Participation</div>
  <div class="overlay" id="intro">This certifies that</div>
  <div class="overlay" id="name">Loading…</div>
  <div class="overlay" id="description">has participated in <span id="talk" AI Fundamental - Boosting Your Productivity</div>
  <div class="overlay" id="date">Date: Loading…</div>
  <div class="overlay" id="issuer">Issued by Kool Ltd</div>
  <div class="overlay" id="timestamp">Minted: Loading…</div>
  <div class="overlay" id="contract">Contract: Loading…</div>
  <div id="verified">Verifying on-chain…</div>
  <!-- <button id="request" onclick="requestNFT()">Request to Collect as NFT</button> -->
</div>

<script>

  const CONTRACT_ADDRESS = "0x739ED265Af12F3e5518884eAc0a32c2eCA92e820";

  const RPC_URL = "https://ethereum-sepolia-rpc.publicnode.com";

  const EXPLORER = "https://sepolia.etherscan.io";

  const abi = [

    "function getReceiverName(uint256) view returns (string)",

    "function getTalkTitle(uint256) view returns (string)",

    "function getEventDate(uint256) view returns (string)",

    "function getIssuer(uint256) view returns (string)",

    "function getTimestamp(uint256) view returns (uint256)",

    "function getImageHash(uint256) view returns (bytes32)"

  ];

  const provider = new ethers.providers.JsonRpcProvider(RPC_URL);

  const contract = new ethers.Contract(CONTRACT_ADDRESS, abi, provider);

  const params = new URLSearchParams(location.search);

  const tokenID = params.get('tokenID');

  const key = params.get('key');

  const validKeys = { "1": "ABC123", "2": "XYZ789" };

  if (!tokenID || !key || validKeys[tokenID] !== key) {

    document.body.innerHTML = "<h1 style='text-align:center;color:#c41e3a;margin-top:100px'>Invalid or missing access key</h1>";

    throw "";

  }

  async function load() {

    try {

      // 1. Fetch all on-chain data

      const [name, title, date, issuer, ts, storedImageHash] = await Promise.all([

        contract.getReceiverName(tokenID),

        contract.getTalkTitle(tokenID),

        contract.getEventDate(tokenID),

        contract.getIssuer(tokenID),

        contract.getTimestamp(tokenID),

        contract.getImageHash(tokenID)

      ]);

      // 2. Populate the certificate

      document.getElementById('name').textContent = name;

      document.getElementById('talk').textContent = title;

      document.getElementById('date').textContent = `Date: ${date}`;

      document.getElementById('issuer').textContent = `Issued by ${issuer}`;

      document.getElementById('timestamp').textContent = `Minted: ${new Date(ts*1000).toLocaleString()}`;

      document.getElementById('contract').innerHTML = `Contract: <a href="${EXPLORER}/address/${CONTRACT_ADDRESS}" target="_blank">${CONTRACT_ADDRESS.slice(0,10)}…${CONTRACT_ADDRESS.slice(-8)}</a>`;

      // 3. Verify the image hash (with timeout to prevent hang)

      const imageUrl = "https://raw.githubusercontent.com/francis-kool/ai-credentials-demo/main/images/ai-talk-credential-template.png";

      const controller = new AbortController();

      const timeoutId = setTimeout(() => controller.abort(), 5000);  // 5-sec timeout

      

      const resp = await fetch(imageUrl, { signal: controller.signal });

      clearTimeout(timeoutId);

      const buffer = await resp.arrayBuffer();

      const hash = ethers.utils.sha256(new Uint8Array(buffer));

      const verified = hash.toLowerCase() === storedImageHash.toLowerCase();

      // 4. Show final status based on real check

      document.getElementById('verified').textContent = verified 

        ? "Fully Verified"

        : "Tempered";

      document.getElementById('verified').style.background = verified ? '#0f5132' : '#842029';

    } catch (e) {

      console.error(e);

      if (e.name === 'AbortError') {

        document.getElementById('verified').textContent = "Data Verified (Image Check Timed Out)";

        document.getElementById('verified').style.background = '#d97706';  // Yellow warning

      } else {

        document.getElementById('verified').textContent = "Verification Failed – Check Console";

        document.getElementById('verified').style.background = "#842029";

      }

    }

  }

  function requestNFT() {

    const wallet = prompt("Your wallet address (0x…):");

    if (!wallet || !ethers.utils.isAddress(wallet)) return alert("Invalid address");

    const email = prompt("Your email:");

    location.href = `mailto:you@kool.ltd?subject=NFT Claim – Token ${tokenID}&body=Name: ${encodeURIComponent(document.getElementById('name').textContent)}%0AWallet: ${wallet}%0AEmail: ${email}%0ATokenID: ${tokenID}`;

  }

  load();

</script>
</body>
</html>





